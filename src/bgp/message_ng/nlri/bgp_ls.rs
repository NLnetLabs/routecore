use std::borrow::Cow;

use crate::bgp::message_ng::{common::AfiSafiType, nlri::{CustomNlriIter, Nlri, NlriIterator}};


pub struct BgpLsNlri<'a> {
    raw: &'a [u8],
}

impl<'a> BgpLsNlri<'a> {

}

impl<'a> Nlri<'a> for BgpLsNlri<'a> {
    const AFI_SAFI_TYPE: AfiSafiType = AfiSafiType::BGPLS;
    type Iterator = BgpLsNlriIter<'a>;

}

impl<'a> NlriIterator<'a> for BgpLsNlriIter<'a> {
    fn empty() -> Self {
        Self { 
            custom_iter: CustomNlriIter::empty_for_afisafi(AfiSafiType::BGPLS),
        }
    }

    fn for_slice(raw: &'a [u8]) -> Self {
        Self {
            custom_iter: CustomNlriIter::unchecked(AfiSafiType::BGPLS, raw)
        }
    }
}

impl<'a> TryFrom<&'a [u8]> for BgpLsNlri<'a> {
    type Error = Cow<'static, str>;

    fn try_from(value: &'a [u8]) -> Result<Self, Self::Error> {
        Ok(BgpLsNlri { raw: value} )
    }
}

pub struct BgpLsNlriIter<'a> {
    custom_iter: CustomNlriIter<'a>,
}

impl<'a> Iterator for BgpLsNlriIter<'a> {
    type Item = BgpLsNlri<'a>;

    fn next(&mut self) -> Option<Self::Item> {
        self.custom_iter.next().map(|raw_nlri|
           raw_nlri.try_into().unwrap() 
        )
    }
}



#[cfg(test)]
mod tests {
    use crate::bgp::message_ng::{common::AfiSafiType, nlri::CustomNlriIter};

    #[test]
    fn parse_multiple_nlri() {
        let raw: [u8; _] = [
            0x00, 0x02, 0x00, 0x6d, 0x02, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
            0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b,
            0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01,
            0x40, 0x00, 0x10, 0x01, 0x01, 0x00, 0x12, 0x02,
            0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62, 0x02,
            0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40, 0x00,
            0x15, 0x01, 0x03, 0x00, 0x04, 0x1d, 0x0e, 0x65,
            0x08, 0x01, 0x04, 0x00, 0x04, 0x1d, 0x0e, 0x65,
            0x09, 0x01, 0x05, 0x00, 0x10, 0x20, 0x01, 0x29,
            0x14, 0x01, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x06, 0x00,
            0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01, 0x00,
            0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x02, 0x00, 0x02, 0x00, 0x6d, 0x02, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
            0x00, 0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00,
            0x0b, 0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29,
            0x01, 0x40, 0x00, 0x21, 0x01, 0x01, 0x00, 0x12,
            0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62,
            0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40,
            0x00, 0x25, 0x01, 0x03, 0x00, 0x04, 0x1d, 0x0e,
            0x65, 0x06, 0x01, 0x04, 0x00, 0x04, 0x1d, 0x0e,
            0x65, 0x07, 0x01, 0x05, 0x00, 0x10, 0x20, 0x01,
            0x29, 0x14, 0x01, 0x01, 0x00, 0x03, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x06,
            0x00, 0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01,
            0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x02, 0x00, 0x02, 0x00, 0x6d, 0x02, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
            0x00, 0x00, 0x12, 0x02, 0x01, 0x00, 0x04, 0x00,
            0x00, 0x0b, 0x62, 0x02, 0x03, 0x00, 0x06, 0x00,
            0x29, 0x01, 0x40, 0x00, 0x50, 0x01, 0x01, 0x00,
            0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b,
            0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01,
            0x40, 0x00, 0x55, 0x01, 0x03, 0x00, 0x04, 0x1d,
            0x0e, 0x65, 0x16, 0x01, 0x04, 0x00, 0x04, 0x1d,
            0x0e, 0x65, 0x17, 0x01, 0x05, 0x00, 0x10, 0x20,
            0x01, 0x29, 0x14, 0x01, 0x01, 0x00, 0x11, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01,
            0x06, 0x00, 0x10, 0x20, 0x01, 0x29, 0x14, 0x01,
            0x01, 0x00, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x02, 0x00, 0x02, 0x00, 0x6d, 0x02,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x00, 0x12, 0x02, 0x01, 0x00, 0x04,
            0x00, 0x00, 0x0b, 0x62, 0x02, 0x03, 0x00, 0x06,
            0x00, 0x29, 0x01, 0x40, 0x00, 0x30, 0x01, 0x01,
            0x00, 0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00,
            0x0b, 0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29,
            0x01, 0x40, 0x00, 0x35, 0x01, 0x03, 0x00, 0x04,
            0x1d, 0x0e, 0x65, 0x20, 0x01, 0x04, 0x00, 0x04,
            0x1d, 0x0e, 0x65, 0x21, 0x01, 0x05, 0x00, 0x10,
            0x20, 0x01, 0x29, 0x14, 0x01, 0x01, 0x00, 0x16,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
            0x01, 0x06, 0x00, 0x10, 0x20, 0x01, 0x29, 0x14,
            0x01, 0x01, 0x00, 0x16, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x02, 0x00, 0x02, 0x00, 0x6d,
            0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x01, 0x00, 0x00, 0x12, 0x02, 0x01, 0x00,
            0x04, 0x00, 0x00, 0x0b, 0x62, 0x02, 0x03, 0x00,
            0x06, 0x00, 0x29, 0x01, 0x40, 0x00, 0x30, 0x01,
            0x01, 0x00, 0x12, 0x02, 0x01, 0x00, 0x04, 0x00,
            0x00, 0x0b, 0x62, 0x02, 0x03, 0x00, 0x06, 0x00,
            0x29, 0x01, 0x40, 0x00, 0x36, 0x01, 0x03, 0x00,
            0x04, 0x1d, 0x0e, 0x65, 0x22, 0x01, 0x04, 0x00,
            0x04, 0x1d, 0x0e, 0x65, 0x23, 0x01, 0x05, 0x00,
            0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01, 0x00,
            0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x01, 0x06, 0x00, 0x10, 0x20, 0x01, 0x29,
            0x14, 0x01, 0x01, 0x00, 0x17, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x02, 0x00,
            0x6d, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x01, 0x00, 0x00, 0x12, 0x02, 0x01,
            0x00, 0x04, 0x00, 0x00, 0x0b, 0x62, 0x02, 0x03,
            0x00, 0x06, 0x00, 0x29, 0x01, 0x40, 0x00, 0x40,
            0x01, 0x01, 0x00, 0x12, 0x02, 0x01, 0x00, 0x04,
            0x00, 0x00, 0x0b, 0x62, 0x02, 0x03, 0x00, 0x06,
            0x00, 0x29, 0x01, 0x40, 0x00, 0x45, 0x01, 0x03,
            0x00, 0x04, 0x1d, 0x0e, 0x65, 0x1e, 0x01, 0x04,
            0x00, 0x04, 0x1d, 0x0e, 0x65, 0x1f, 0x01, 0x05,
            0x00, 0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01,
            0x00, 0x15, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x01, 0x01, 0x06, 0x00, 0x10, 0x20, 0x01,
            0x29, 0x14, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x02,
            0x00, 0x6d, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x12, 0x02,
            0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62, 0x02,
            0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40, 0x00,
            0x50, 0x01, 0x01, 0x00, 0x12, 0x02, 0x01, 0x00,
            0x04, 0x00, 0x00, 0x0b, 0x62, 0x02, 0x03, 0x00,
            0x06, 0x00, 0x29, 0x01, 0x40, 0x00, 0x56, 0x01,
            0x03, 0x00, 0x04, 0x1d, 0x0e, 0x65, 0x18, 0x01,
            0x04, 0x00, 0x04, 0x1d, 0x0e, 0x65, 0x19, 0x01,
            0x05, 0x00, 0x10, 0x20, 0x01, 0x29, 0x14, 0x01,
            0x01, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x01, 0x01, 0x06, 0x00, 0x10, 0x20,
            0x01, 0x29, 0x14, 0x01, 0x01, 0x00, 0x12, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00,
            0x02, 0x00, 0x6d, 0x02, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x12,
            0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62,
            0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40,
            0x00, 0x60, 0x01, 0x01, 0x00, 0x12, 0x02, 0x01,
            0x00, 0x04, 0x00, 0x00, 0x0b, 0x62, 0x02, 0x03,
            0x00, 0x06, 0x00, 0x29, 0x01, 0x40, 0x00, 0x65,
            0x01, 0x03, 0x00, 0x04, 0x1d, 0x0e, 0x65, 0x14,
            0x01, 0x04, 0x00, 0x04, 0x1d, 0x0e, 0x65, 0x15,
            0x01, 0x05, 0x00, 0x10, 0x20, 0x01, 0x29, 0x14,
            0x01, 0x01, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x01, 0x06, 0x00, 0x10,
            0x20, 0x01, 0x29, 0x14, 0x01, 0x01, 0x00, 0x10,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02,
            0x00, 0x02, 0x00, 0x6d, 0x02, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
            0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b,
            0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01,
            0x40, 0x00, 0x20, 0x01, 0x01, 0x00, 0x12, 0x02,
            0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62, 0x02,
            0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40, 0x00,
            0x25, 0x01, 0x03, 0x00, 0x04, 0x1d, 0x0e, 0x65,
            0x02, 0x01, 0x04, 0x00, 0x04, 0x1d, 0x0e, 0x65,
            0x03, 0x01, 0x05, 0x00, 0x10, 0x20, 0x01, 0x29,
            0x14, 0x01, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x06, 0x00,
            0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01, 0x00,
            0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x02, 0x00, 0x02, 0x00, 0x6d, 0x02, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
            0x00, 0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00,
            0x0b, 0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29,
            0x01, 0x40, 0x00, 0x11, 0x01, 0x01, 0x00, 0x12,
            0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62,
            0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40,
            0x00, 0x15, 0x01, 0x03, 0x00, 0x04, 0x1d, 0x0e,
            0x65, 0x0c, 0x01, 0x04, 0x00, 0x04, 0x1d, 0x0e,
            0x65, 0x0d, 0x01, 0x05, 0x00, 0x10, 0x20, 0x01,
            0x29, 0x14, 0x01, 0x01, 0x00, 0x06, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x06,
            0x00, 0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01,
            0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x02
        ];

        let iter = CustomNlriIter::new_checked(AfiSafiType::BGPLS, &raw).unwrap();
        assert_eq!(iter.count(), 10);

    }
}
