use std::borrow::Cow;

use crate::bgp::message_ng::common::AfiSafiType;


#[derive(Debug)]
pub struct CustomNlriIter<'a> {
    afisafi: AfiSafiType,
    raw: &'a [u8],
}

impl<'a> CustomNlriIter<'a> {
    pub fn new_checked(afisafi: AfiSafiType, raw: &'a [u8]) -> Result<Self, (Self, &'a [u8])> {
        Self {
            afisafi,
            raw,
        }.check()
    }
    fn try_nlri_length(&self) -> Result<usize, Cow<'static, str>> {
        match self.afisafi {
            AfiSafiType::BGPLS => {
                if self.raw.len() < 4 {
                    return Err("foo".into());
                }
                Ok(usize::from(u16::from_be_bytes([self.raw[2], self.raw[3]])))
            },
            _ => {
                return Err(format!("No custom iterator support for {}", self.afisafi).into());
            }
        }
    }

    fn static_length(&self) -> usize {
        match self.afisafi {
            AfiSafiType::BGPLS => 4,
            _ => usize::MAX, // this way, the other checks will fail 'gracefully'
        }
    }

    // to be used in actual iteration
    fn unchecked_nlri_length(&self) -> usize {
        match self.afisafi {
            AfiSafiType::BGPLS => {
                usize::from(u16::from_be_bytes([self.raw[2], self.raw[3]]))
            }
            _ => unreachable!()
        }
    }

    fn check(self) -> Result<Self, (Self, &'a [u8])> {
        Ok(self) // FIXME TODO XXX
    }
}


impl<'a> Iterator for CustomNlriIter<'a> {
    type Item = &'a [u8];

    fn next(&mut self) -> Option<Self::Item> {
        if self.raw.len() == 0 {
            return None
        }

        let len_bytes = &self.afisafi.nlri_length(&self.raw);
        
        debug_assert!(self.raw.len() >= self.static_length() + len_bytes, "illegal NLRI length");

        let res = Some(&self.raw[..self.static_length()+len_bytes]);
        self.raw = &self.raw[self.static_length()+len_bytes..];

        res
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn parse_multiple_nlri() {
        let raw: [u8; _] = [
            0x00, 0x02, 0x00, 0x6d, 0x02, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
            0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b,
            0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01,
            0x40, 0x00, 0x10, 0x01, 0x01, 0x00, 0x12, 0x02,
            0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62, 0x02,
            0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40, 0x00,
            0x15, 0x01, 0x03, 0x00, 0x04, 0x1d, 0x0e, 0x65,
            0x08, 0x01, 0x04, 0x00, 0x04, 0x1d, 0x0e, 0x65,
            0x09, 0x01, 0x05, 0x00, 0x10, 0x20, 0x01, 0x29,
            0x14, 0x01, 0x01, 0x00, 0x04, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x06, 0x00,
            0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01, 0x00,
            0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x02, 0x00, 0x02, 0x00, 0x6d, 0x02, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
            0x00, 0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00,
            0x0b, 0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29,
            0x01, 0x40, 0x00, 0x21, 0x01, 0x01, 0x00, 0x12,
            0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62,
            0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40,
            0x00, 0x25, 0x01, 0x03, 0x00, 0x04, 0x1d, 0x0e,
            0x65, 0x06, 0x01, 0x04, 0x00, 0x04, 0x1d, 0x0e,
            0x65, 0x07, 0x01, 0x05, 0x00, 0x10, 0x20, 0x01,
            0x29, 0x14, 0x01, 0x01, 0x00, 0x03, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x06,
            0x00, 0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01,
            0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x02, 0x00, 0x02, 0x00, 0x6d, 0x02, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
            0x00, 0x00, 0x12, 0x02, 0x01, 0x00, 0x04, 0x00,
            0x00, 0x0b, 0x62, 0x02, 0x03, 0x00, 0x06, 0x00,
            0x29, 0x01, 0x40, 0x00, 0x50, 0x01, 0x01, 0x00,
            0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b,
            0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01,
            0x40, 0x00, 0x55, 0x01, 0x03, 0x00, 0x04, 0x1d,
            0x0e, 0x65, 0x16, 0x01, 0x04, 0x00, 0x04, 0x1d,
            0x0e, 0x65, 0x17, 0x01, 0x05, 0x00, 0x10, 0x20,
            0x01, 0x29, 0x14, 0x01, 0x01, 0x00, 0x11, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01,
            0x06, 0x00, 0x10, 0x20, 0x01, 0x29, 0x14, 0x01,
            0x01, 0x00, 0x11, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x02, 0x00, 0x02, 0x00, 0x6d, 0x02,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x00, 0x00, 0x12, 0x02, 0x01, 0x00, 0x04,
            0x00, 0x00, 0x0b, 0x62, 0x02, 0x03, 0x00, 0x06,
            0x00, 0x29, 0x01, 0x40, 0x00, 0x30, 0x01, 0x01,
            0x00, 0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00,
            0x0b, 0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29,
            0x01, 0x40, 0x00, 0x35, 0x01, 0x03, 0x00, 0x04,
            0x1d, 0x0e, 0x65, 0x20, 0x01, 0x04, 0x00, 0x04,
            0x1d, 0x0e, 0x65, 0x21, 0x01, 0x05, 0x00, 0x10,
            0x20, 0x01, 0x29, 0x14, 0x01, 0x01, 0x00, 0x16,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
            0x01, 0x06, 0x00, 0x10, 0x20, 0x01, 0x29, 0x14,
            0x01, 0x01, 0x00, 0x16, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x02, 0x00, 0x02, 0x00, 0x6d,
            0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x01, 0x00, 0x00, 0x12, 0x02, 0x01, 0x00,
            0x04, 0x00, 0x00, 0x0b, 0x62, 0x02, 0x03, 0x00,
            0x06, 0x00, 0x29, 0x01, 0x40, 0x00, 0x30, 0x01,
            0x01, 0x00, 0x12, 0x02, 0x01, 0x00, 0x04, 0x00,
            0x00, 0x0b, 0x62, 0x02, 0x03, 0x00, 0x06, 0x00,
            0x29, 0x01, 0x40, 0x00, 0x36, 0x01, 0x03, 0x00,
            0x04, 0x1d, 0x0e, 0x65, 0x22, 0x01, 0x04, 0x00,
            0x04, 0x1d, 0x0e, 0x65, 0x23, 0x01, 0x05, 0x00,
            0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01, 0x00,
            0x17, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x01, 0x01, 0x06, 0x00, 0x10, 0x20, 0x01, 0x29,
            0x14, 0x01, 0x01, 0x00, 0x17, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x02, 0x00,
            0x6d, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x01, 0x00, 0x00, 0x12, 0x02, 0x01,
            0x00, 0x04, 0x00, 0x00, 0x0b, 0x62, 0x02, 0x03,
            0x00, 0x06, 0x00, 0x29, 0x01, 0x40, 0x00, 0x40,
            0x01, 0x01, 0x00, 0x12, 0x02, 0x01, 0x00, 0x04,
            0x00, 0x00, 0x0b, 0x62, 0x02, 0x03, 0x00, 0x06,
            0x00, 0x29, 0x01, 0x40, 0x00, 0x45, 0x01, 0x03,
            0x00, 0x04, 0x1d, 0x0e, 0x65, 0x1e, 0x01, 0x04,
            0x00, 0x04, 0x1d, 0x0e, 0x65, 0x1f, 0x01, 0x05,
            0x00, 0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01,
            0x00, 0x15, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x01, 0x01, 0x06, 0x00, 0x10, 0x20, 0x01,
            0x29, 0x14, 0x01, 0x01, 0x00, 0x15, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x02,
            0x00, 0x6d, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x12, 0x02,
            0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62, 0x02,
            0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40, 0x00,
            0x50, 0x01, 0x01, 0x00, 0x12, 0x02, 0x01, 0x00,
            0x04, 0x00, 0x00, 0x0b, 0x62, 0x02, 0x03, 0x00,
            0x06, 0x00, 0x29, 0x01, 0x40, 0x00, 0x56, 0x01,
            0x03, 0x00, 0x04, 0x1d, 0x0e, 0x65, 0x18, 0x01,
            0x04, 0x00, 0x04, 0x1d, 0x0e, 0x65, 0x19, 0x01,
            0x05, 0x00, 0x10, 0x20, 0x01, 0x29, 0x14, 0x01,
            0x01, 0x00, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x01, 0x01, 0x06, 0x00, 0x10, 0x20,
            0x01, 0x29, 0x14, 0x01, 0x01, 0x00, 0x12, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00,
            0x02, 0x00, 0x6d, 0x02, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x12,
            0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62,
            0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40,
            0x00, 0x60, 0x01, 0x01, 0x00, 0x12, 0x02, 0x01,
            0x00, 0x04, 0x00, 0x00, 0x0b, 0x62, 0x02, 0x03,
            0x00, 0x06, 0x00, 0x29, 0x01, 0x40, 0x00, 0x65,
            0x01, 0x03, 0x00, 0x04, 0x1d, 0x0e, 0x65, 0x14,
            0x01, 0x04, 0x00, 0x04, 0x1d, 0x0e, 0x65, 0x15,
            0x01, 0x05, 0x00, 0x10, 0x20, 0x01, 0x29, 0x14,
            0x01, 0x01, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x01, 0x01, 0x06, 0x00, 0x10,
            0x20, 0x01, 0x29, 0x14, 0x01, 0x01, 0x00, 0x10,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02,
            0x00, 0x02, 0x00, 0x6d, 0x02, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
            0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b,
            0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01,
            0x40, 0x00, 0x20, 0x01, 0x01, 0x00, 0x12, 0x02,
            0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62, 0x02,
            0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40, 0x00,
            0x25, 0x01, 0x03, 0x00, 0x04, 0x1d, 0x0e, 0x65,
            0x02, 0x01, 0x04, 0x00, 0x04, 0x1d, 0x0e, 0x65,
            0x03, 0x01, 0x05, 0x00, 0x10, 0x20, 0x01, 0x29,
            0x14, 0x01, 0x01, 0x00, 0x01, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x06, 0x00,
            0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01, 0x00,
            0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x02, 0x00, 0x02, 0x00, 0x6d, 0x02, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00,
            0x00, 0x12, 0x02, 0x01, 0x00, 0x04, 0x00, 0x00,
            0x0b, 0x62, 0x02, 0x03, 0x00, 0x06, 0x00, 0x29,
            0x01, 0x40, 0x00, 0x11, 0x01, 0x01, 0x00, 0x12,
            0x02, 0x01, 0x00, 0x04, 0x00, 0x00, 0x0b, 0x62,
            0x02, 0x03, 0x00, 0x06, 0x00, 0x29, 0x01, 0x40,
            0x00, 0x15, 0x01, 0x03, 0x00, 0x04, 0x1d, 0x0e,
            0x65, 0x0c, 0x01, 0x04, 0x00, 0x04, 0x1d, 0x0e,
            0x65, 0x0d, 0x01, 0x05, 0x00, 0x10, 0x20, 0x01,
            0x29, 0x14, 0x01, 0x01, 0x00, 0x06, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x06,
            0x00, 0x10, 0x20, 0x01, 0x29, 0x14, 0x01, 0x01,
            0x00, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x02
        ];

        let iter = CustomNlriIter::new_checked(AfiSafiType::BGPLS, &raw).unwrap();
        assert_eq!(iter.count(), 10);

    }
}
